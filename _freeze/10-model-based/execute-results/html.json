{
  "hash": "8955e037d17ec15b500f55b3813615a4",
  "result": {
    "markdown": "# Model-based clustering {#sec-mclust}\n\n\\index{cluster analysis!model-based} \n\nModel-based clustering @FR02 fits a multivariate normal mixture model to the data. It uses the EM algorithm to fit the parameters for the mean, variance--covariance of each population, and the mixing proportion. The variance-covariance matrix is re-parametrized using an eigen-decomposition\n\n$$\n\\Sigma_k = \\lambda_kD_kA_kD_k^\\top, ~~~k=1, \\dots, g ~~\\mbox{(number of clusters)}\n$$\n\n\\noindent resulting in several model choices, ranging from simple to complex, as shown in @tbl-covariances.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Load libraries\"}\nlibrary(dplyr)\nlibrary(kableExtra)\nlibrary(ggplot2)\nlibrary(mclust)\nlibrary(mulgar)\nlibrary(patchwork)\nlibrary(colorspace)\nlibrary(tourr)\n```\n:::\n\n::: {#tbl-covariances .cell tbl-cap='Parameterizations of the covariance matrix.'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> Model </th>\n   <th style=\"text-align:center;\"> Sigma </th>\n   <th style=\"text-align:center;\"> Family </th>\n   <th style=\"text-align:center;\"> Volume </th>\n   <th style=\"text-align:center;\"> Shape </th>\n   <th style=\"text-align:center;\"> Orientation </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> EII </td>\n   <td style=\"text-align:center;\"> $$\\lambda I$$ </td>\n   <td style=\"text-align:center;\"> Spherical </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VII </td>\n   <td style=\"text-align:center;\"> $$\\lambda_k I$$ </td>\n   <td style=\"text-align:center;\"> Spherical </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> EEI </td>\n   <td style=\"text-align:center;\"> $$\\lambda A$$ </td>\n   <td style=\"text-align:center;\"> Diagonal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Coordinate axes </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VEI </td>\n   <td style=\"text-align:center;\"> $$\\lambda_kA$$ </td>\n   <td style=\"text-align:center;\"> Diagonal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Coordinate axes </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> EVI </td>\n   <td style=\"text-align:center;\"> $$\\lambda A_k$$ </td>\n   <td style=\"text-align:center;\"> Diagonal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Coordinate axes </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VVI </td>\n   <td style=\"text-align:center;\"> $$\\lambda_k A_k$$ </td>\n   <td style=\"text-align:center;\"> Diagonal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Coordinate axes </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> EEE </td>\n   <td style=\"text-align:center;\"> $$\\lambda DAD^\\top$$ </td>\n   <td style=\"text-align:center;\"> Diagonal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> EVE </td>\n   <td style=\"text-align:center;\"> $$\\lambda DA_kD^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Equal </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VEE </td>\n   <td style=\"text-align:center;\"> $$\\lambda_k DAD^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VVE </td>\n   <td style=\"text-align:center;\"> $$\\lambda_k DA_kD^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> EEV </td>\n   <td style=\"text-align:center;\"> $$\\lambda D_kAD_k^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VEV </td>\n   <td style=\"text-align:center;\"> $$\\lambda_k D_kAD_k^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> EVV </td>\n   <td style=\"text-align:center;\"> $$\\lambda D_kA_kD_k^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Equal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> VVV </td>\n   <td style=\"text-align:center;\"> $$\\lambda_k D_kA_kD_k^\\top$$ </td>\n   <td style=\"text-align:center;\"> Ellipsoidal </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n   <td style=\"text-align:center;\"> Variable </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\\noindent Note the distribution descriptions \"spherical\" and \"ellipsoidal\". These are descriptions of the shape of the variance-covariance for a multivariate normal distribution. A standard multivariate normal distribution has a variance-covariance matrix with zeros in the off-diagonal elements, which corresponds to spherically shaped data. When the variances (diagonals) are different or the variables are correlated, then the shape of data from a multivariate normal is ellipsoidal.\n\n\\index{Bayes Information Criterion (BIC)}\n\nThe models are typically scored using the Bayes Information Criterion (BIC), which is based on the log likelihood, number of variables, and number of mixture components. They should also be assessed using graphical methods, as we demonstrate using the \\Data{penguins} data. \n\n## Examining the model in 2D\n\nWe start with two of the four real-valued variables (`bl`, `fl`) and the three `species`. The goal is to determine whether model-based methods can discover clusters that closely correspond to the three species. Based on the scatterplot in @fig-penguins-bl-fl we would expect it to do well, and suggest an elliptical variance-covariance of roughly equal sizes as the model.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code to make plot\"}\nload(\"data/penguins_sub.rda\")\nggplot(penguins_sub, aes(x=bl, \n                         y=fl)) + #, \n                         #colour=species)) +\n  geom_point() +\n  geom_density2d(colour=\"#3B99B1\") +\n  theme_minimal() +\n  theme(aspect.ratio = 1)\n```\n\n::: {.cell-output-display}\n![Scatterplot of flipper length by bill length of the penguins data.](10-model-based_files/figure-html/fig-penguins-bl-fl-1.png){#fig-penguins-bl-fl width=480}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\npenguins_BIC <- mclustBIC(penguins_sub[,c(1,3)])\nggmc <- ggmcbic(penguins_BIC, cl=2:9, top=4) + \n  scale_color_discrete_divergingx(palette = \"Roma\") +\n  ggtitle(\"(a)\") +\n  theme_minimal() \npenguins_mc <- Mclust(penguins_sub[,c(1,3)], \n                      G=3, \n                      modelNames = \"EVE\")\npenguins_mce <- mc_ellipse(penguins_mc)\npenguins_cl <- penguins_sub[,c(1,3)]\npenguins_cl$cl <- factor(penguins_mc$classification)\nggell <- ggplot() +\n   geom_point(data=penguins_cl, aes(x=bl, y=fl,\n                                    colour=cl),\n              alpha=0.3) +\n   geom_point(data=penguins_mce$ell, aes(x=bl, y=fl,\n                                         colour=cl),\n              shape=16) +\n   geom_point(data=penguins_mce$mn, aes(x=bl, y=fl,\n                                        colour=cl),\n              shape=3, size=2) +\n  scale_color_discrete_divergingx(palette = \"Zissou 1\")  +\n  theme_minimal() +\n  theme(aspect.ratio=1, legend.position=\"none\") +\n  ggtitle(\"(b)\")\nggmc + ggell + plot_layout(ncol=2)\n```\n\n::: {.cell-output-display}\n![Summary plots from model-based clustering: (a) BIC values for clusters 2-9 of top four models, (b) variance-covariance ellipses and cluster means (+) corresponding to the best model. The best model is three-cluster EVE, which has differently shaped variance-covariances albeit the same volume and orientation.](10-model-based_files/figure-html/fig-penguins-bl-fl-mc-1.png){#fig-penguins-bl-fl-mc width=768}\n:::\n:::\n\n\n@fig-penguins-bl-fl-mc summarises the results. All models agree that three clusters is the best. The different variance-covariance models for three clusters have similar BIC values with EVE (different shape, same volume and orientation) being slightly higher. These plots are made from the `mclust` package output using the `ggmcbic` and `mc_ellipse` functions fro the `mulgar` package.\n\n## Extending to higher dimensions\n\nNow we will examine how model-based clustering will group the penguins data using all four variables. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-fold=\"false\"}\npenguins_BIC <- mclustBIC(penguins_sub[,1:4])\nggmc <- ggmcbic(penguins_BIC, cl=2:9, top=7) + \n  scale_color_discrete_divergingx(palette = \"Roma\") +\n  theme_minimal() \nggmc\n```\n\n::: {.cell-output-display}\n![BIC values for the top models for 2-9 clusters on the penguins data. The interpretation is mixed: if one were to choose three clusters any of the variance-covariance models would be equally as good, but the very best model is the four-cluster VEE.](10-model-based_files/figure-html/fig-penguins-bic-1.png){#fig-penguins-bic fig-align='center' width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\npenguins_mc <- Mclust(penguins_sub[,1:4], \n                      G=4, \n                      modelNames = \"VEE\")\npenguins_mce <- mc_ellipse(penguins_mc)\npenguins_cl <- penguins_sub\npenguins_cl$cl <- factor(penguins_mc$classification)\n\npenguins_mc_data <- penguins_cl %>%\n  select(bl:bm, cl) %>%\n  mutate(type = \"data\") %>%\n  bind_rows(bind_cols(penguins_mce$ell,\n                      type=rep(\"ellipse\",\n                               nrow(penguins_mce$ell)))) %>%\n  mutate(type = factor(type))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Code to make animated gifs\"}\nanimate_xy(penguins_mc_data[,1:4],\n           col=penguins_mc_data$cl,\n           pch=c(4, 20 )[as.numeric(penguins_mc_data$type)], \n           axes=\"off\")\n\nload(\"data/penguins_tour_path.rda\")\nrender_gif(penguins_mc_data[,1:4], \n           planned_tour(pt1), \n           display_xy(col=penguins_mc_data$cl,\n               pch=c(4, 20)[\n                 as.numeric(penguins_mc_data$type)], \n                      axes=\"off\",\n               half_range = 0.7),\n           gif_file=\"gifs/penguins_best_mc.gif\",\n           frames=500,\n           loop=FALSE)\n\npenguins_mc <- Mclust(penguins_sub[,1:4], \n                      G=3, \n                      modelNames = \"EEE\")\npenguins_mce <- mc_ellipse(penguins_mc)\npenguins_cl <- penguins_sub\npenguins_cl$cl <- factor(penguins_mc$classification)\n\npenguins_mc_data <- penguins_cl %>%\n  select(bl:bm, cl) %>%\n  mutate(type = \"data\") %>%\n  bind_rows(bind_cols(penguins_mce$ell,\n                      type=rep(\"ellipse\",\n                               nrow(penguins_mce$ell)))) %>%\n  mutate(type = factor(type))\n\nanimate_xy(penguins_mc_data[,1:4],\n           col=penguins_mc_data$cl,\n           pch=c(4, 20)[as.numeric(penguins_mc_data$type)], \n           axes=\"off\")\n\n# Save the animated gif\nload(\"data/penguins_tour_path.rda\")\nrender_gif(penguins_mc_data[,1:4], \n           planned_tour(pt1), \n           display_xy(col=penguins_mc_data$cl,\n               pch=c(4, 20)[\n                 as.numeric(penguins_mc_data$type)], \n                      axes=\"off\",\n               half_range = 0.7),\n           gif_file=\"gifs/penguins_simpler_mc.gif\",\n           frames=500,\n           loop=FALSE)\n```\n:::\n\n\n::: {#fig-penguins-mc layout-ncol=2}\n\n::: {.content-hidden when-format=\"pdf\"}\n![Best model: four-cluster VEE](gifs/penguins_best_mc.gif){#fig-penguins-best_mc fig-alt=\"FIX ME\" fig.align=\"center\"}\n:::\n\n::: {.content-hidden when-format=\"pdf\"}\n![Three-cluster EEE](gifs/penguins_simpler_mc.gif){#fig-penguins-simpler_mc fig-alt=\"FIX ME\" fig.align=\"center\"}\n:::\n\nExamining the model-based clustering results for the penguins data: (a) best model according to BIC value, (b) simpler three-cluster model. Dots are ellipse points, and \"x\" are data points. It is important to note that the three cluster solution fits the data better, even though it has a lower BIC. \n:::\n\n::: info\nUsing the tour to visualise the final choices of models with similarly high BIC values helps to choose which best fits the data. It may not be the one with the highest BIC value. \n:::\n\n\n::: {.cell}\n\n:::\n\n\n## Exercises {-}\n\n1. Examine the three cluster EVE, VVE and VEE models with the tour, and explain whether these are distinguishably different from the EEE three cluster model.\n2. Fit model-based clustering to the the `clusters`. Does it suggest the data has three clusters? Using the tour examine the best model model. How well does this fit the data?\n3. Fit model-based clustering to the the `multicluster`. Does it suggest the data has six clusters? Using the tour examine the best model model. How well does this fit the data?\n4. Fit model-based clustering to the `fake_trees` data. Does it suggest that the data has 10 clusters? If not, why do you think this is?  Using the tour examine the best model model. How well does this fit the branching structure?\n5. Try fitting model-based clustering to the `aflw` data? What is the best model? Is the solution related to offensive vs defensive vs mid-fielder skills?\n6. Use model-based clustering on the challenge data sets, `c1`-`c7` from the `mulgar` package. Explain why or why not the best model fits the cluster structure or not.\n",
    "supporting": [
      "10-model-based_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}